#+title: Emacs From Scratch Configuration
#+STARTUP: content
#+PROPERTY: header-args:emacs-lisp :tangle ./init.el :mkdirp yes

* Startup Performance
** Ignore Annoying Message 
#+begin_src emacs-lisp
  ;;; init.el --- Generated by Emacs.org
  ;;; Commentary:
  ;; NOTE: init.el is now generated from Emacs.org.  Please edit that file
  ;;       in Emacs and init.el will be generated automatically!
  (setq warning-suppress-types '((comp) (native-comp)))
  (setq inhibit-startup-message t)
  (defalias 'yes-or-no-p 'y-or-n-p)
#+end_src
** Measure Loading Time Performance
#+begin_src emacs-lisp
  ;; The default is 800 kilobytes.  Measured in bytes.
  (setq gc-cons-threshold (* 128 1000 1000))

  (defun bc/display-startup-time ()
    (message "Emacs loaded in %s with %d garbage collections."
	     (format "%.2f seconds"
		     (float-time
		      (time-subtract after-init-time before-init-time)))
	     gcs-done))

  (add-hook 'emacs-startup-hook #'bc/display-startup-time)
#+end_Src


* Package System Setup
** Straight.el
straight.el: next-generation, purely functional package manager for the Emacs
hacker.

#+begin_src emacs-lisp
  (defvar bootstrap-version)
  (let ((bootstrap-file
	 (expand-file-name
	  "straight/repos/straight.el/bootstrap.el"
	  (or (bound-and-true-p straight-base-dir)
	      user-emacs-directory)))
	(bootstrap-version 7))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
	  (url-retrieve-synchronously
	   "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
	   'silent 'inhibit-cookies)
	(goto-char (point-max))
	(eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))
  ;;By default, use-package uses package.el to install packages
  ;;To configure use-package to always use straight.el, use use-package to configure straight.el
  ;;to turn on straight-use-package-by-default.
  (use-package straight
    :ensure nil
    :custom
    (straight-use-package-by-default t))

#+end_src


* Basic Setup
** PATH
#+begin_src emacs-lisp
  (if (eq system-type 'darwin)
      (use-package exec-path-from-shell
	:straight t
	:config
	 (exec-path-from-shell-initialize))
    )

#+end_src
** Keep Folders Clean
use the no-littering package to keep folders where we edit files and the Emacs
configuration folder clean! It knows about a wide variety of variables for built
in Emacs features as well as those from community packages so it can be much
easier than finding and setting these variables yourself.

#+begin_src emacs-lisp
  (use-package no-littering
    :straight t
    :config
    (require 'recentf)
    (add-to-list 'recentf-exclude no-littering-var-directory)
    (add-to-list 'recentf-exclude no-littering-etc-directory)

    ;; no-littering doesn't set this by default so we must place
    ;; auto save files in the same path as it uses for sessions
    (setq auto-save-file-name-transforms
	  `((".*" ,(no-littering-expand-var-file-name "auto-save/") t)))

    ;; Emacs will save customizations into your init.el file by default. If you don't
    ;; want that, you might want to store them in a sibling file or even in the etc/
    ;; directory:

    (setq custom-file (no-littering-expand-etc-file-name "custom.el"))
    )
  (setq make-backup-files nil)
#+end_src

** Auto Wrap lines
#+begin_src emacs-lisp
  (global-visual-line-mode 1)
#+end_src

** Window Switch
#+begin_src emacs-lisp
  (use-package ace-window
    :straight t)
  (global-set-key (kbd "M-o") 'ace-window)
#+end_src

** Ivy & Counsel
***Obsolted***
Ivy is an excellent completion framework for Emacs. It provides a minimal yet
powerful selection menu that appears when you open files, switch buffers, and
for many other tasks in Emacs. Counsel is a customized set of commands to
replace `find-file` with `counsel-find-file`, etc which provide useful commands
for each of the default completion commands.

ivy-rich adds extra columns to a few of the Counsel commands to provide more
information about each item.

#+begin_src emacs-lisp
  ;; (use-package ivy
  ;;   :straight t
  ;;   :bind (
  ;; 	   ("C-s" . swiper)
  ;; 	   :map ivy-minibuffer-map
  ;; 	   ("TAB" . ivy-alt-done)
  ;; 	   ("C-l" . ivy-alt-done)
  ;; 	   ("C-j" . ivy-next-line)
  ;; 	   ("C-k" . ivy-previous-line)
  ;; 	   :map ivy-switch-buffer-map
  ;; 	   ("C-k" . ivy-previous-line)
  ;; 	   ("C-l" . ivy-done)
  ;; 	   ("C-d" . ivy-switch-buffer-kill)
  ;; 	   :map ivy-reverse-i-search-map
  ;; 	   ("C-k" . ivy-previous-line)
  ;; 	   ("C-d" . ivy-reverse-i-search-kill))
  ;;   :config
  ;;   (setq ivy-use-virtual-buffers t)
  ;;   (setq ivy-wrap t)
  ;;   (setq ivy-count-format "(%d/%d) ")
  ;;   (setq enable-recursive-minibuffers t)

  ;;   (setq ivy-initial-inputs-alist nil)

  ;;   ;; Use different regex strategies per completion command
  ;;   ;; (push '(completion-at-point . ivy--regex-fuzzy) ivy-re-builders-alist)
  ;;   (push '(swiper . ivy--regex-ignore-order) ivy-re-builders-alist)
  ;;   (push '(counsel-M-x . ivy--regex-ignore-order) ivy-re-builders-alist)

  ;;   ;; Set minibuffer height for different commands
  ;;   (setf (alist-get 'counsel-projectile-ag ivy-height-alist) 15)
  ;;   (setf (alist-get 'counsel-projectile-rg ivy-height-alist) 15)
  ;;   (setf (alist-get 'swiper ivy-height-alist) 15)
  ;;   (setf (alist-get 'counsel-switch-buffer ivy-height-alist) 7)

  ;;   (ivy-mode 1))

  ;; (use-package counsel
  ;;   :straight t
  ;;   :bind (("M-x" . counsel-M-x)
  ;; 	   ("C-x b" . counsel-switch-buffer)
  ;; 	   ("C-M-j" . 'counsel-switch-buffer)
  ;; 	   ("C-x C-b" . counsel-ibuffer)
  ;; 	   ("M-y" . counsel-yank-pop)
  ;; 	   ("C-x C-r" . counsel-recentf)
  ;; 	   ("C-x C-f" . counsel-find-file)
  ;; 	   :map minibuffer-local-map
  ;; 	   ("C-r" . 'counsel-minibuffer-history))
  ;;   ;;:custom
  ;;   ;;(counsel-linux-app-format-function #'counsel-linux-app-format-function-name-only)
  ;;   :config
  ;;   (counsel-mode 1))

  ;; (use-package ivy-prescient
  ;;   :straight t
  ;; :after counsel
  ;; :custom
  ;; (ivy-prescient-enable-filtering nil)
  ;; :config
  ;; ;; Uncomment the following line to have sorting remembered across sessions!
  ;; (prescient-persist-mode 1)
  ;; (ivy-prescient-mode 1))

  ;; (use-package smex ;; adds M-x recent commmand sorting for counsel-M-x
  ;;   :straight t
  ;;   :after counsel)

#+end_src

** Consult & Vertico
#+begin_src emacs-lisp
  ;; basic completion frame work
  (use-package vertico
    :straight t
    :init (vertico-mode))

  ;; math frame
  ;; Emacs Corfu (Completion Overlay Region FU) 是一个用于 Emacs 的补全框架，
  ;; 它提供了一种新的用户界面来显示补全候选项。Corfu 是 Emacs的一个外部包，
  ;; 它致力于提供一种直观且高效的补全体验。以下是一些 Corfu 的主要特性和功能：

  (use-package corfu
    :straight t
    :custom
    (corfu-auto t)
    (corfu-cycle t)
    :hook ((prog-mode . corfu-mode))
    :bind
    (:map corfu-map
    	("TAB" . corfu-next)
    	([tab] . corfu-next)
    	("S-TAB" . corfu-previous)
    	([backtab] . corfu-previous))
    :init
    (global-corfu-mode))

  ;; Optionally use the `orderless' completion style.
  (use-package orderless
    :custom
    ;; Configure a custom style dispatcher (see the Consult wiki)
    ;; (orderless-style-dispatchers '(+orderless-dispatch))
    ;; (orderless-component-separator #'orderless-escapable-split-on-space)
    (completion-styles '(orderless basic))
    (completion-category-defaults nil)
    (completion-category-overrides '((file (styles basic partial-completion)))))

  ;; search engine
  (use-package consult
    :straight t
    :bind (("C-s" . consult-line)
    	 ("C-c s" . consult-ripgrep)
    	 ("M-y" . consult-yank-pop)
    	 ("C-x b" . consult-buffer)))

  ;; provide context sensitive action
  (use-package embark
    :straight t
    :bind (("C-." . embark-act)))

  ;; 可选：增强 minibuffer 显示
  (use-package marginalia
    :ensure t
    :init
    (marginalia-mode 1))
#+end_src
** Projectile
#+begin_src emacs-lisp
  (use-package projectile
    :straight t
    :config
    (projectile-mode t))
#+end_src
** Dashboard
#+begin_src emacs-lisp
  (use-package nerd-icons
    :straight t)
  
  (use-package dashboard
  :straight t
  :config
  ;; 基础设置
  (setq dashboard-center-content t)
  (setq dashboard-items '((recents   . 5)
			(bookmarks . 5)
			(projects  . 5)
			(agenda    . 5)
			(registers . 5)))
  (setq dashboard-item-shortcuts '((recents   . "r")
				 (bookmarks . "m")
				 (projects  . "p")
				 (agenda    . "a")
				 (registers . "e")))
  (setq dashboard-display-icons-p t)     ; display icons on both GUI and terminal
  (setq dashboard-icon-type 'nerd-icons) ; use `nerd-icons' package


  (setq dashboard-startupify-list '(dashboard-insert-banner
				  dashboard-insert-newline
				  dashboard-insert-banner-title
				  dashboard-insert-newline
				  dashboard-insert-navigator
				  dashboard-insert-newline
				  dashboard-insert-init-info
				  dashboard-insert-items
				  dashboard-insert-newline
				  dashboard-insert-footer))

  ;; 自定义横幅和标题
  (dashboard-setup-startup-hook))
#+end_src

** UI
*** Modeline
#+begin_src emacs-lisp
  (use-package doom-modeline
  :straight t
  :init
  (doom-modeline-mode 1))
#+end_src
*** File tree
#+begin_src emacs-lisp
  (use-package treemacs
    :straight t
    :config
    (treemacs-follow-mode t))
#+end_src
*** Hightlight
#+begin_src emacs-lisp
  (global-visual-line-mode 1)

  (if (display-graphic-p)
      (progn
        (scroll-bar-mode -1)        ; Disable visible scrollbar
        (tool-bar-mode -1)          ; Disable the toolbar
        (tooltip-mode -1)           ; Disable tooltips
        (set-fringe-mode 10)        ; Give some breathing room
        (menu-bar-mode -1)            ; Disable the menu bar
        ))

  ;; Set up the visible bell
  (setq visible-bell t)
  (display-time-mode 1)
  (column-number-mode)
  (global-display-line-numbers-mode t)

  ;; Set frame transparenc
  (defvar my/frame-transparency '(95 . 95))
  (set-frame-parameter (selected-frame) 'alpha my/frame-transparency)
  (add-to-list 'default-frame-alist `(alpha . ,my/frame-transparency))
  ;; (set-frame-parameter (selected-frame) 'fullscreen 'maximized)
  ;; (add-to-list 'default-frame-alist '(fullscreen . maximized))

  ;; Get font from https://www.fontsquirrel.com/fonts
  (defvar my/default-font-size 160)
  (defvar my/default-variable-font-size 160)
  (if (display-graphic-p)
      (progn
        ;; Set the fixed pitch face
        (set-face-attribute 'fixed-pitch nil :font "JetBrains Mono" :height my/default-font-size)
        (set-face-attribute 'default nil :font "JetBrains Mono" :height my/default-font-size)
        (set-face-attribute 'variable-pitch nil :font "Source Sans Pro" :height my/default-font-size :weight 'regular)
        ))

  (use-package unicode-fonts
    :straight t)

  (require 'unicode-fonts)
  (unicode-fonts-setup)
  (cond
   ((eq system-type 'darwin)
    (setq initial-frame-alist '((top . 10)
          		      (left . 60)
          			      (width . 85)
          			      (height . 50))))
   ((eq system-type 'windows-nt)
    (setq initial-frame-alist '((top . 10)
          		      (left . 10)
          		      (width . 100)
          		      (height . 45))))
   (t
    (message "for other system")))

  (use-package dimmer
      :straight t)
  (require 'dimmer)
  (dimmer-configure-which-key)
  (dimmer-mode t)

  (use-package diff-hl
    :straight t)
  (global-diff-hl-mode)

  (use-package tree-sitter
    :straight t)

  (setq treesit-extra-load-path '("~/.emacs.d/tree-sitter/"))
  
#+end_src

*** Theme
#+begin_src emacs-lisp

  (use-package doom-themes
    :straight t
    :config
    (load-theme 'doom-gruvbox t))
  ;; (load-theme 'doom-one t))
  ;; (use-package ef-themes
  ;;  :straight t
  ;;  :config
  ;;  (load-theme 'ef-dark t))

#+end_src


* Programing
** Company
#+begin_src emacs-lisp
  (use-package  company
    :straight t
    :config
    (global-company-mode)
    (setq company-idle-delay 0.5)
    )
  (use-package company-box
    :straight t
    :hook
    (company-mode . company-box-mode))
#+end_src
** Eglot
#+begin_src emacs-lisp
  (require 'eglot)
  (setq eldoc-echo-area-use-multiline-p nil)
  #+end_src
** LSP
#+begin_src emacs-lisp
  (use-package rust-mode
    :straight t)

  (add-to-list 'auto-mode-alist '("CMakeLists\\.txt\\'" . cmake-ts-mode))
  (add-to-list 'auto-mode-alist '("\\.cmake\\'" . cmake-ts-mode))

  (with-eval-after-load 'eglot 
    (cond
     ;; macOS 设置 (使用 MacPorts 安装的 clangd)
     ((eq system-type 'darwin)
      (add-to-list 'eglot-server-programs '(c-ts-mode . ("/opt/local/bin/clangd-mp-20")))
      (add-to-list 'eglot-server-programs '(c++-ts-mode . ("/opt/local/bin/clangd-mp-20"))))
     
     ;; Linux 设置
     ((eq system-type 'gnu/linux)
      (add-to-list 'eglot-server-programs '(c-ts-mode . ("/usr/bin/clangd")))
      (add-to-list 'eglot-server-programs '(c++-ts-mode . ("/usr/bin/clangd"))))
     
     ;; 默认 fallback 设置（如 Windows 或未知平台）
     (t
      (add-to-list 'eglot-server-programs '(c-ts-mode . ("clangd")))
      (add-to-list 'eglot-server-programs '(c++-ts-mode . ("clangd")))))) 

  ;; (add-to-list 'eglot-server-programs '(python-ts-mode . ("pylsp")))

  (add-to-list 'eglot-server-programs
             '(python-ts-mode . ("pyright-langserver" "--stdio")))

  (use-package direnv
    :straight t
    :config
    (direnv-mode))

  (setq major-mode-remap-alist
        '((python-mode . python-ts-mode)
  	(c-mode . c-ts-mode)
  	(c++-mode . c++-ts-mode)
  	(cmake-mode . cmake-ts-mode)
  	))
  ;; hook ts-mode to eglot
  (dolist (mode '(c-ts-mode c++-ts-mode python-ts-mode))
      (add-hook (intern (concat (symbol-name mode) "-hook"))
  	                  #'eglot-ensure))

  (use-package rustic
  :straight t
  :bind (:map rustic-mode-map
         ("C-c C-c C-c" . rustic-cargo-run)
         ("C-c C-c C-t" . rustic-cargo-test)
         ("C-c C-c C-k" . rustic-cargo-check)
         ("C-c C-c C-l" . rustic-cargo-clippy)
         ("C-c C-c C-f" . rustic-format-buffer))
  :config
  (setq rustic-lsp-client 'eglot))
#+end_src

** Linter
#+begin_src emacs-lisp
  (with-eval-after-load 'flymake
    (define-key flymake-mode-map (kbd "C-c ! l") 'flymake-show-buffer-diagnostics)
    (define-key flymake-mode-map (kbd "C-c ! n") 'flymake-goto-next-error)
    (define-key flymake-mode-map (kbd "C-c ! p") 'flymake-goto-prev-error))

  (setq flymake-no-changes-timeout nil) ;; 避免自动触发，不干扰打字
  (setq flymake-start-on-save-buffer t)
  (setq flymake-start-on-flymake-mode t)

  (add-hook 'prog-mode-hook 'flymake-mode)

  ;; 自动显示 diagnostic 信息（如 tooltip）
  (add-hook 'post-command-hook #'flymake-show-diagnostic-if-needed)

  (defun flymake-show-diagnostic-if-needed ()
    "在 minibuffer 中显示当前光标下的诊断信息。"
    (when-let ((diags (flymake-diagnostics (point) (point))))
      (message "%s"
               (mapconcat (lambda (diag)
                            (flymake-diagnostic-text diag))
                          diags "\n"))))
  
#+end_src


* Keymap
** Evil Mode
Evil is an extensible vi layer for Emacs. It emulates the main features of Vim,
turning Emacs into a modal editor. Like Emacs in general, Evil is extensible in
Emacs Lisp.

#+begin_src emacs-lisp
  (use-package evil
    :straight t
    :init
    (setq evil-want-integration t)
    (setq evil-want-keybinding nil)
    (setq evil-want-C-u-scroll t)
    (setq evil-want-C-i-jump nil)
    :config
    (evil-mode 1)
    (define-key evil-insert-state-map (kbd "C-g") 'evil-normal-state)
    (define-key evil-insert-state-map (kbd "C-h") 'evil-delete-backward-char-and-join)

    ;; Use visual line motions even outside of visual-line-mode buffers
    (evil-global-set-key 'motion "j" 'evil-next-visual-line)
    (evil-global-set-key 'motion "k" 'evil-previous-visual-line)

    (define-key evil-motion-state-map " " nil)

    (evil-set-initial-state 'messages-buffer-mode 'normal)
    (evil-set-initial-state 'dashboard-mode 'normal))

  (use-package evil-nerd-commenter
    :straight t
    :config
    (evilnc-default-hotkeys))

  ;; general package will be slow.  use evil-leader first
  (use-package evil-collection
    :straight t
    :after evil
    :custom
    (evil-collection-setup-minibuffer t)
    :config
    (evil-collection-init))

  (with-eval-after-load 'evil
    (define-key evil-normal-state-map (kbd "C-z") 'suspend-frame)
    (define-key evil-insert-state-map (kbd "C-z") 'suspend-frame)
    (define-key evil-emacs-state-map (kbd "C-z") 'suspend-frame)

    (define-key evil-normal-state-map (kbd "C-M-z") 'evil-emacs-state)
    (define-key evil-emacs-state-map (kbd "C-M-z") 'evil-exit-emacs-state))
#+end_src

** Which Key 
which-key is a minor mode for Emacs that displays the key bindings following
your currently entered incomplete command (a prefix) in a popup.
#+begin_src emacs-lisp
  (use-package which-key
    :straight t
    :config
    (which-key-mode)  ;; Enable which-key
    (setq which-key-idle-delay 0.3)  ;; Show keybinding hints after a short delay
    ;;(setq which-key-popup-type 'side-window)  ;; Display keybindings in a side window (other options: 'mini-window)
    ;;(setq which-key-side-window-location 'right)  ;; Position the popup on the right side of the screen
    ;; side-window cause running timer error
    (setq which-key-max-description-length 30)  ;; Max length for descriptions in the popup
    (setq which-key-min-display-lines 10)  ;; Show at least 10 lines in the popup
    (setq which-key-show-early-on-C-h t)  ;; Show keybindings as soon as you press `C-h`
  )
#+end_src


* Markdown Mode
** Basic configuration
#+begin_src emacs-lisp
  ;; basic syntax highlight
  (use-package markdown-mode
    :straight t
    :mode ("\\.md\\'" . markdown-mode)
    :config
    (setq markdown-fontify-code-blocks-natively t)
    (setq markdown-command "pandoc"))

  ;; render the markdown file
  (use-package grip-mode
    :straight t
    :hook (markdown-mode . grip-mode)
    :config
    (setq grip-update-after-change nil))

  ;; 自动识别 vault
  ;; 双向链接补全（[[link]]）
  ;; 快速新建笔记
  ;; 反向链接查看
  ;; 支持 dired 中的 vault 导航
  (use-package obsidian
    :straight t
    :demand t
    :config
    (if (eq system-type 'darwin)
        (setq obsidian-directory "~/Documents/Obsidian/")
      (setq obsidian-directory (concat (getenv "USERPROFILE") "\\Documents\\Obsidian_ParaVault")))
    
    (global-obsidian-mode t)
    (setq obsidian-inbox-directory "00_Inbox")
    (setq obsidian-completion-trigger "[[")
    
    ;; 如果你想在保存时自动格式化 Markdown，可以手动挂钩 markdown-mode：
    (add-hook 'markdown-mode-hook
              (lambda ()
                (add-hook 'before-save-hook #'obsidian-format-buffer nil t)))
    
    )
#+end_src


* Org Mode
** Format Org File
#+begin_src emacs-lisp
  (require 'org-tempo)
  (setq-default fill-column 80)
  (add-hook 'org-mode-hook 'turn-on-auto-fill)
#+end_src
